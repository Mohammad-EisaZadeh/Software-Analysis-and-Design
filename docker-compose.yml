services:
  # Databases
  auth-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  resource-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: resource_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - resource_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  marketplace-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: marketplace_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - marketplace_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  elearning-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: elearning_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - elearning_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - notification_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  iot-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: iot_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - iot_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  shuttle-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: shuttle_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - shuttle_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  course-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: course_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - course_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Message Broker
  rabbitmq:
    image: rabbitmq:3-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Cache
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Services
  auth-service:
    build: ./services/auth-service
    environment:
      PORT: 3002
      DB_HOST: auth-db
      DB_PORT: 5432
      DB_NAME: auth_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      JWT_SECRET: your-secret-key-change-in-production
    depends_on:
      auth-db:
        condition: service_healthy
    ports:
      - "3002:3002"

  resource-service:
    build: ./services/resource-service
    environment:
      PORT: 3003
      DB_HOST: resource-db
      DB_PORT: 5432
      DB_NAME: resource_db
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      resource-db:
        condition: service_healthy
    ports:
      - "3003:3003"

  marketplace-service:
    build: ./services/marketplace-service
    environment:
      PORT: 3004
      DB_HOST: marketplace-db
      DB_PORT: 5432
      DB_NAME: marketplace_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      RABBITMQ_URL: amqp://rabbitmq:5672
      REDIS_URL: redis://redis:6379
    depends_on:
      marketplace-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3004:3004"

  elearning-service:
    build: ./services/elearning-service
    environment:
      PORT: 3005
      DB_HOST: elearning-db
      DB_PORT: 5432
      DB_NAME: elearning_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      NOTIFICATION_SERVICE_URL: http://notification-service:3006
    depends_on:
      elearning-db:
        condition: service_healthy
    ports:
      - "3005:3005"

  notification-service:
    build: ./services/notification-service
    environment:
      PORT: 3006
      DB_HOST: notification-db
      DB_PORT: 5432
      DB_NAME: notification_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      RABBITMQ_URL: amqp://rabbitmq:5672
    depends_on:
      notification-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports:
      - "3006:3006"

  iot-service:
    build: ./services/iot-service
    environment:
      PORT: 3007
      DB_HOST: iot-db
      DB_PORT: 5432
      DB_NAME: iot_db
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      iot-db:
        condition: service_healthy
    ports:
      - "3007:3007"

  shuttle-service:
    build: ./services/shuttle-service
    environment:
      PORT: 3008
      DB_HOST: shuttle-db
      DB_PORT: 5432
      DB_NAME: shuttle_db
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      shuttle-db:
        condition: service_healthy
    ports:
      - "3008:3008"

  course-service:
    build: ./services/course-service
    environment:
      PORT: 3009
      DB_HOST: course-db
      DB_PORT: 5432
      DB_NAME: course_db
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      course-db:
        condition: service_healthy
    ports:
      - "3009:3009"

  # API Gateway
  api-gateway:
    build: ./gateway
    environment:
      PORT: 3001
      JWT_SECRET: your-secret-key-change-in-production
      FRONTEND_URL: http://localhost:3000
      AUTH_SERVICE_URL: http://auth-service:3002
      RESOURCES_SERVICE_URL: http://resource-service:3003
      MARKETPLACE_SERVICE_URL: http://marketplace-service:3004
      ELEARNING_SERVICE_URL: http://elearning-service:3005
      NOTIFICATIONS_SERVICE_URL: http://notification-service:3006
      IOT_SERVICE_URL: http://iot-service:3007
      SHUTTLE_SERVICE_URL: http://shuttle-service:3008
      COURSE_SERVICE_URL: http://course-service:3009
    depends_on:
      - auth-service
      - resource-service
      - marketplace-service
      - elearning-service
      - notification-service
      - iot-service
      - shuttle-service
      - course-service
    ports:
      - "3001:3001"

  # Frontend (Next.js)
  frontend:
    build: .
    environment:
      PORT: 3000
      NEXT_PUBLIC_API_BASE_URL: http://localhost:3001
    depends_on:
      - api-gateway
    ports:
      - "3000:3000"

volumes:
  auth_db_data:
  resource_db_data:
  marketplace_db_data:
  elearning_db_data:
  notification_db_data:
  iot_db_data:
  shuttle_db_data:
  course_db_data:
  rabbitmq_data:
  redis_data:


